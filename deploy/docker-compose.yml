version: "3.9"

services:
  db:
    image: postgres:18
    entrypoint: ["/usr/local/bin/custom-entrypoint.sh"]
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-hackorum}
    volumes:
      # Postgres 18+ stores data under /var/lib/postgresql/<major>/main
      - pgdata:/var/lib/postgresql
      - pgwal:/var/lib/postgresql/wal-archive
      - pgbackups:/backups
      - ./postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro # copy from postgresql.conf.example
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
      - ./postgres/entrypoint.sh:/usr/local/bin/custom-entrypoint.sh:ro
    command:
      [
        "postgres",
        "-c", "config_file=/etc/postgresql/postgresql.conf"
      ]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-hackorum}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    labels:
      autoheal: "true"

  web:
    build: ..
    env_file: .env
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-hackorum}}
      PGHOST: db
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER:-postgres}
      PGPASSWORD: ${POSTGRES_PASSWORD:-postgres}
      PGDATABASE: ${POSTGRES_DB:-hackorum}
      # Run Solid Queue supervisor inside Puma so background jobs (emails, etc.) get processed.
      SOLID_QUEUE_IN_PUMA: "1"
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}
      # Mail configuration
      APP_HOST: ${APP_HOST}
      MAIL_DOMAIN: ${MAIL_DOMAIN}
      MAIL_FROM: ${MAIL_FROM}
      SMTP_ADDRESS: ${SMTP_ADDRESS}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_DOMAIN: ${SMTP_DOMAIN}
      SMTP_USERNAME: ${SMTP_USERNAME}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
    depends_on:
      db:
        condition: service_healthy
    expose:
      - "3000"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/up || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    labels:
      autoheal: "true"

  imap_worker:
    build: ..
    command: ["bundle", "exec", "ruby", "script/imap_idle.rb"]
    env_file: .env
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-hackorum}}
      PGHOST: db
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER:-postgres}
      PGPASSWORD: ${POSTGRES_PASSWORD:-postgres}
      PGDATABASE: ${POSTGRES_DB:-hackorum}
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "ps -ef | grep -v grep | grep -q imap_idle.rb"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    labels:
      autoheal: "true"

  caddy:
    image: caddy:latest
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      web:
        condition: service_started
    restart: unless-stopped

  autoheal:
    image: willfarrell/autoheal
    environment:
      AUTOHEAL_CONTAINER_LABEL: autoheal
      AUTOHEAL_INTERVAL: 30
      AUTOHEAL_START_PERIOD: 60
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped

  psql:
    image: postgres:18
    entrypoint: ["psql", "postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-hackorum}"]
    env_file: .env
    depends_on:
      db:
        condition: service_healthy
    profiles: ["tools"]

volumes:
  pgdata:
  pgwal:
  pgbackups:
  caddy_data:
  caddy_config:
